# Complete Workflow Example

This shows a complete example of setting up and using the Search Deploy CLI with any static site generator.

## Overview

```
Static Site ‚Üí Build ‚Üí Generates search-index-*.json ‚Üí CLI uploads to KV ‚Üí Worker serves API
```

## Project Structure

```
my-static-site/
‚îú‚îÄ‚îÄ content/          # Your content (docs, pages, etc.)
‚îú‚îÄ‚îÄ build/            # Built site (generated)
‚îÇ   ‚îú‚îÄ‚îÄ index.html
‚îÇ   ‚îú‚îÄ‚îÄ search-index-default.json  ‚Üê Generated by your site
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ .env
‚îî‚îÄ‚îÄ .searchdeployrc.json
```

## Step-by-Step Setup

### 1. Install CLI

```bash
npm install --save-dev @cmfcmf/docusaurus-search-deploy
```

### 2. Initialize Configuration

```bash
npx search-deploy init
```

This creates:
- `.searchdeployrc.json` - Configuration file
- `.env.example` - Environment variables template

**Generated .searchdeployrc.json:**
```json
{
  "buildDir": "./build",
  "cloudflare": {
    "accountId": "${CLOUDFLARE_ACCOUNT_ID}",
    "apiToken": "${CLOUDFLARE_API_TOKEN}",
    "kvNamespaceId": "${CLOUDFLARE_KV_NAMESPACE_ID}",
    "workerName": "search-worker"
  }
}
```

### 3. Set Up Cloudflare

```bash
# Login to Cloudflare
npx wrangler login

# Create KV namespace
npx wrangler kv:namespace create SEARCH_INDEXES

# Output:
# { binding = "SEARCH_INDEXES", id = "abc123def456..." }
```

### 4. Configure Environment Variables

Create `.env` file:

```bash
CLOUDFLARE_ACCOUNT_ID=your-account-id
CLOUDFLARE_API_TOKEN=your-api-token
CLOUDFLARE_KV_NAMESPACE_ID=abc123def456...
```

**Getting credentials:**
- **Account ID**: Cloudflare Dashboard ‚Üí Workers & Pages ‚Üí Overview
- **API Token**: Dashboard ‚Üí My Profile ‚Üí API Tokens ‚Üí Create Token
  - Use "Edit Cloudflare Workers" template

### 5. Update package.json Scripts

```json
{
  "name": "my-site",
  "scripts": {
    "build": "your-build-command",
    "postbuild": "search-deploy",
    "deploy": "npm run build"
  }
}
```

### 6. Build and Deploy

```bash
# Build your site (must generate search-index-*.json files)
npm run build

# Indexes are automatically uploaded! üéâ
```

## Expected Index Format

Your site generator must produce files matching:

**Filename:** `search-index-{tag}.json`

**Format:**
```json
{
  "documents": [
    {
      "id": 1,
      "pageTitle": "Page Title",
      "sectionTitle": "Section Title",
      "sectionRoute": "/path#anchor",
      "type": "docs"
    }
  ],
  "index": {
    // Serialized Lunr.js index object
    "version": "2.3.9",
    "fields": ["title", "content"],
    "ref": "id",
    "pipeline": [...],
    "documentStore": {...},
    "tokenSet": {...},
    "corpusTokens": [...],
    "index": {...}
  }
}
```

## CI/CD Integration

### GitHub Actions

**.github/workflows/deploy.yml:**

```yaml
name: Deploy Site

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build

      - name: Deploy search indexes
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_KV_NAMESPACE_ID: ${{ secrets.CLOUDFLARE_KV_NAMESPACE_ID }}
        run: npx search-deploy

      # Deploy your site to hosting (GitHub Pages, Netlify, etc.)
      - name: Deploy site
        run: npm run deploy:hosting
```

### GitLab CI

**.gitlab-ci.yml:**

```yaml
deploy:
  stage: deploy
  image: node:18
  script:
    - npm ci
    - npm run build
    - npx search-deploy
  only:
    - main
  variables:
    CLOUDFLARE_ACCOUNT_ID: $CLOUDFLARE_ACCOUNT_ID
    CLOUDFLARE_API_TOKEN: $CLOUDFLARE_API_TOKEN
    CLOUDFLARE_KV_NAMESPACE_ID: $CLOUDFLARE_KV_NAMESPACE_ID
```

### Configure CI Secrets

Add these secrets to your CI/CD platform:
- `CLOUDFLARE_ACCOUNT_ID`
- `CLOUDFLARE_API_TOKEN`
- `CLOUDFLARE_KV_NAMESPACE_ID`

## Deploy the Worker (One-Time)

To enable the search API endpoint:

### Option 1: Use included worker

```bash
# The worker is in packages/cloudflare-worker/
cd packages/cloudflare-worker

# Update wrangler.toml with your KV namespace ID
vim wrangler.toml

# Deploy
npm install
npm run deploy
```

### Option 2: Copy to your project

```bash
# Copy worker files
mkdir -p cloudflare-worker
cp -r node_modules/@cmfcmf/docusaurus-search-local-worker/* cloudflare-worker/

cd cloudflare-worker
npm install
npm run deploy
```

Your search API is now live at:
```
https://search-worker.your-subdomain.workers.dev
```

## Using the Search API

### Test the API

```bash
# Your worker URL
WORKER_URL="https://search-worker.your-subdomain.workers.dev"

# Search
curl -X POST $WORKER_URL/search \
  -H "Content-Type: application/json" \
  -d '{"query": "getting started"}'

# Response
{
  "results": [
    {
      "id": 1,
      "pageTitle": "Getting Started",
      "sectionTitle": "Introduction",
      "sectionRoute": "/docs/intro#introduction",
      "type": "docs",
      "score": 2.5
    }
  ],
  "total": 1,
  "query": "getting started",
  "took": 15
}
```

### Integrate in Your Site

```javascript
// Add to your site's JavaScript
async function search(query) {
  const response = await fetch('https://your-worker.workers.dev/search', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ query })
  });
  return response.json();
}

// Use it
const results = await search('installation');
console.log(results.results);
```

## Development Workflow

### Local Development

```bash
# Make changes to content
vim content/docs/page.md

# Rebuild
npm run build

# Test deployment (dry run)
npx search-deploy --dry-run

# Deploy
npx search-deploy
```

### Production Deployment

```bash
# Commit changes
git add .
git commit -m "Update documentation"
git push origin main

# CI/CD automatically:
# 1. Builds site
# 2. Deploys search indexes
# 3. Deploys site
```

## Verification

### Check Deployed Indexes

```bash
# List indexes via API
curl https://your-worker.workers.dev/indexes

# Or via wrangler
npx wrangler kv:key list --namespace-id abc123def456...
```

### Test Search Functionality

```bash
# Test various queries
curl -X POST https://your-worker.workers.dev/search \
  -d '{"query": "installation"}'

curl -X POST https://your-worker.workers.dev/search \
  -d '{"query": "getting started", "maxResults": 5}'

# Test with GET
curl "https://your-worker.workers.dev/search?q=api&maxResults=10"
```

## Updating Content

When you update your content:

```bash
# 1. Edit content
vim content/docs/new-page.md

# 2. Build
npm run build

# 3. Deploy (or let CI do it)
git push
```

The CLI automatically:
- Detects changed indexes
- Uploads only what's needed
- Worker picks up changes immediately

## Monitoring

### View Deployment Logs

```bash
# During deployment
npm run build

# Output:
# üöÄ Search Index Deploy
# ‚úì Found 2 index file(s)
# ‚úì Uploaded 2 index file(s) to Cloudflare KV
# ‚úÖ Deployment complete!
```

### Monitor Worker

```bash
# Tail worker logs
npx search-deploy worker --logs

# Or via wrangler
npx wrangler tail
```

### Cloudflare Analytics

1. Go to Cloudflare Dashboard
2. Workers & Pages ‚Üí Your Worker
3. View metrics:
   - Requests per second
   - Error rate
   - CPU time
   - Success rate

## Troubleshooting

### Build succeeds but no indexes found

Ensure your site generator creates `search-index-*.json` files:

```bash
# Check build output
ls -la build/search-index-*.json

# Should show files like:
# search-index-default.json
```

### Deployment fails with auth error

```bash
# Verify credentials
echo $CLOUDFLARE_ACCOUNT_ID
echo $CLOUDFLARE_KV_NAMESPACE_ID

# Regenerate API token if needed
# Make sure token has "Workers KV Storage:Edit" permission
```

### Worker returns 404 for searches

```bash
# Verify indexes were uploaded
npx wrangler kv:key list --namespace-id abc123def456...

# Re-upload if missing
npm run build
npx search-deploy
```

### Search returns empty results

```bash
# Check index format
cat build/search-index-default.json | jq '.documents | length'

# Should show number of indexed documents
```

## Best Practices

1. **Version Control**: Don't commit `.env` or secrets
2. **CI/CD Only**: Deploy search indexes only from CI/CD in production
3. **Testing**: Use `--dry-run` to test before deploying
4. **Monitoring**: Check Cloudflare dashboard regularly
5. **Caching**: Worker caches indexes in memory for fast responses

## Cost Tracking

Typical static site costs (free tier):

- **Builds**: ~50/month (GitHub Actions: free)
- **Search requests**: ~10,000/month (Cloudflare: free)
- **KV storage**: ~5MB (Cloudflare: free)
- **Worker requests**: ~100,000/month (Cloudflare: free)

**Total monthly cost: $0** ‚úÖ

## Advanced Usage

### Multiple Environments

```bash
# Development
search-deploy --config .searchdeployrc.dev.json

# Staging
search-deploy --config .searchdeployrc.staging.json

# Production
search-deploy --config .searchdeployrc.prod.json
```

### Custom Deployment Script

```javascript
// deploy-search.js
const { deploy, loadConfig } = require('@cmfcmf/docusaurus-search-deploy');

async function customDeploy() {
  console.log('Running pre-deployment checks...');

  const config = await loadConfig();
  await deploy(config);

  console.log('Sending notification...');
  // Your custom logic
}

customDeploy();
```

### Programmatic API

```javascript
const { deploy, loadConfig } = require('@cmfcmf/docusaurus-search-deploy');

async function deployIndexes() {
  const config = await loadConfig();

  // Custom config overrides
  config.options = {
    verbose: true,
    dryRun: process.env.DRY_RUN === 'true',
  };

  await deploy(config);
}
```

## Next Steps

- Set up monitoring and alerts
- Add search analytics tracking
- Implement autocomplete suggestions
- Create custom search UI
- Add multi-language support

## Support

- Check the [README](./README.md) for detailed documentation
- Review [Cloudflare Worker docs](../cloudflare-worker/README.md)
- Open issues on GitHub
